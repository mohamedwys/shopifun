{%- comment -%}
  Modern Collection Grid
  ======================
  Product grid with sidebar filters, sort controls, active filter pills,
  and load-more pagination.
{%- endcomment -%}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .modern-collection-layout {
    display: grid;
    gap: var(--space-xl);
  }
  @media screen and (min-width: 990px) {
    .modern-collection-layout--sidebar {
      grid-template-columns: 260px 1fr;
    }
  }

  .modern-filter-sidebar {
    position: sticky;
    top: calc(var(--header-height, 80px) + var(--space-lg));
    max-height: calc(100vh - var(--header-height, 80px) - var(--space-2xl));
    overflow-y: auto;
    scrollbar-width: thin;
  }
  @media screen and (max-width: 989px) {
    .modern-filter-sidebar {
      position: fixed;
      inset: 0;
      z-index: var(--z-drawer);
      background: var(--color-background);
      padding: var(--space-xl);
      transform: translateX(-100%);
      transition: transform var(--duration-normal) var(--ease-out);
      max-height: 100vh;
      top: 0;
    }
    .modern-filter-sidebar.is-open {
      transform: translateX(0);
    }
  }

  .modern-filter-group {
    border-bottom: 1px solid rgba(128,128,128,0.15);
    padding: var(--space-lg) 0;
  }
  .modern-filter-group:first-child { padding-top: 0; }

  .modern-filter-group__toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: none;
    border: none;
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    color: inherit;
    padding: 0;
  }
  .modern-filter-group__toggle svg {
    width: 16px;
    height: 16px;
    transition: transform var(--duration-fast) var(--ease-out);
  }
  .modern-filter-group.is-collapsed .modern-filter-group__toggle svg {
    transform: rotate(-90deg);
  }
  .modern-filter-group__body {
    margin-top: var(--space-md);
    display: grid;
    gap: var(--space-xs);
    overflow: hidden;
    transition: max-height var(--duration-normal) var(--ease-out), opacity var(--duration-normal) var(--ease-out);
  }
  .modern-filter-group.is-collapsed .modern-filter-group__body {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
  }

  .modern-filter-option {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    cursor: pointer;
    padding: var(--space-xs) 0;
    transition: opacity var(--duration-fast) var(--ease-out);
  }
  .modern-filter-option:hover { opacity: 0.7; }
  .modern-filter-option input { display: none; }
  .modern-filter-option__check {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(128,128,128,0.3);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--duration-fast) var(--ease-out);
    flex-shrink: 0;
  }
  .modern-filter-option input:checked + .modern-filter-option__check {
    background: var(--color-button, #000);
    border-color: var(--color-button, #000);
  }
  .modern-filter-option__check svg {
    width: 12px; height: 12px;
    stroke: #fff; stroke-width: 3;
    opacity: 0;
    transform: scale(0.5);
    transition: all var(--duration-fast) var(--ease-out);
  }
  .modern-filter-option input:checked + .modern-filter-option__check svg {
    opacity: 1;
    transform: scale(1);
  }
  .modern-filter-option__count {
    margin-left: auto;
    opacity: 0.5;
    font-size: var(--text-xs);
  }

  .modern-collection-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    flex-wrap: wrap;
  }

  .modern-active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
  }
  .modern-active-filter-pill {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-md);
    background: rgba(128,128,128,0.1);
    border: none;
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    animation: filterPillIn var(--duration-fast) var(--ease-out) forwards;
  }
  .modern-active-filter-pill:hover { background: rgba(128,128,128,0.2); }
  .modern-active-filter-pill svg { width: 12px; height: 12px; }
  @keyframes filterPillIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }

  .modern-sort-select {
    position: relative;
    display: inline-flex;
  }
  .modern-sort-select select {
    appearance: none;
    background: transparent;
    border: 1px solid rgba(128,128,128,0.2);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-2xl) var(--space-sm) var(--space-md);
    font-size: var(--text-sm);
    color: inherit;
    cursor: pointer;
    font-family: inherit;
  }
  .modern-sort-select::after {
    content: '';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    border: 4px solid transparent;
    border-top-color: currentColor;
    pointer-events: none;
  }

  .modern-filter-mobile-toggle {
    display: none;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-lg);
    background: transparent;
    border: 1px solid rgba(128,128,128,0.2);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    cursor: pointer;
    color: inherit;
    font-family: inherit;
  }
  @media screen and (max-width: 989px) {
    .modern-filter-mobile-toggle { display: inline-flex; }
  }
  .modern-filter-mobile-toggle svg { width: 16px; height: 16px; }

  .modern-collection-product-grid {
    display: grid;
    grid-template-columns: repeat({{ section.settings.columns_mobile }}, 1fr);
    gap: var(--space-md);
  }
  @media screen and (min-width: 750px) {
    .modern-collection-product-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-lg);
    }
  }
  @media screen and (min-width: 990px) {
    .modern-collection-product-grid {
      grid-template-columns: repeat({{ section.settings.columns_desktop }}, 1fr);
      gap: var(--space-xl);
    }
  }

  .modern-load-more {
    display: flex;
    justify-content: center;
    margin-top: var(--space-3xl);
  }
  .modern-load-more__btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-3xl);
    border: 2px solid rgba(128,128,128,0.2);
    background: transparent;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    color: inherit;
    font-family: inherit;
  }
  .modern-load-more__btn:hover {
    background: var(--color-button, #000);
    color: var(--color-button-text, #fff);
    border-color: var(--color-button, #000);
  }

  .modern-filter-overlay {
    display: none;
  }
  @media screen and (max-width: 989px) {
    .modern-filter-overlay {
      display: block;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: calc(var(--z-drawer) - 1);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--duration-normal) var(--ease-out);
    }
    .modern-filter-overlay.is-open {
      opacity: 1;
      pointer-events: auto;
    }
  }

  .modern-filter-sidebar__close {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-xs);
    color: inherit;
    margin-bottom: var(--space-lg);
    margin-left: auto;
  }
  .modern-filter-sidebar__close svg { width: 24px; height: 24px; }
  @media screen and (max-width: 989px) {
    .modern-filter-sidebar__close { display: block; }
  }
{%- endstyle -%}

{%- liquid
  assign products_per_page = section.settings.products_per_page
-%}

<div class="color-{{ section.settings.color_scheme }} gradient">
  <div class="page-width section-{{ section.id }}-padding">
    <div class="modern-collection-layout{% if section.settings.show_filters and section.settings.filter_layout == 'sidebar' %} modern-collection-layout--sidebar{% endif %}">

      {%- comment -%} Filter Sidebar {%- endcomment -%}
      {%- if section.settings.show_filters -%}
        <div class="modern-filter-overlay" id="FilterOverlay-{{ section.id }}" onclick="this.classList.remove('is-open');document.getElementById('FilterSidebar-{{ section.id }}').classList.remove('is-open')"></div>
        <aside class="modern-filter-sidebar" id="FilterSidebar-{{ section.id }}">
          <button class="modern-filter-sidebar__close" onclick="this.parentElement.classList.remove('is-open');document.getElementById('FilterOverlay-{{ section.id }}').classList.remove('is-open')" aria-label="Close filters">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
          <h3 style="font-size:var(--text-base);font-weight:700;text-transform:uppercase;letter-spacing:var(--tracking-wider);margin:0 0 var(--space-lg)">Filters</h3>

          {%- for filter in collection.filters -%}
            <div class="modern-filter-group" data-filter-group>
              <button class="modern-filter-group__toggle" onclick="this.parentElement.classList.toggle('is-collapsed')" aria-expanded="true">
                {{ filter.label | escape }}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
              </button>
              <div class="modern-filter-group__body" style="max-height:400px;opacity:1">
                {%- case filter.type -%}
                  {%- when 'list' -%}
                    {%- for value in filter.values -%}
                      <label class="modern-filter-option">
                        <input type="checkbox" name="{{ value.param_name }}" value="{{ value.value }}" {% if value.active %}checked{% endif %}>
                        <span class="modern-filter-option__check">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 6L9 17l-5-5"/></svg>
                        </span>
                        <span>{{ value.label | escape }}</span>
                        <span class="modern-filter-option__count">({{ value.count }})</span>
                      </label>
                    {%- endfor -%}
                  {%- when 'price_range' -%}
                    <div style="display:flex;gap:var(--space-sm);align-items:center">
                      <div style="flex:1">
                        <label style="font-size:var(--text-xs);opacity:0.6;display:block;margin-bottom:var(--space-2xs)">Min</label>
                        <input type="number" name="{{ filter.min_value.param_name }}" value="{{ filter.min_value.value }}" min="0" placeholder="{{ filter.range_min | money_without_currency }}" style="width:100%;padding:var(--space-sm);border:1px solid rgba(128,128,128,0.2);border-radius:var(--radius-md);font-size:var(--text-sm);background:transparent;color:inherit">
                      </div>
                      <span style="opacity:0.4;padding-top:var(--space-lg)">&mdash;</span>
                      <div style="flex:1">
                        <label style="font-size:var(--text-xs);opacity:0.6;display:block;margin-bottom:var(--space-2xs)">Max</label>
                        <input type="number" name="{{ filter.max_value.param_name }}" value="{{ filter.max_value.value }}" max="{{ filter.range_max | money_without_currency }}" placeholder="{{ filter.range_max | money_without_currency }}" style="width:100%;padding:var(--space-sm);border:1px solid rgba(128,128,128,0.2);border-radius:var(--radius-md);font-size:var(--text-sm);background:transparent;color:inherit">
                      </div>
                    </div>
                  {%- endcase -%}
              </div>
            </div>
          {%- endfor -%}
        </aside>
      {%- endif -%}

      {%- comment -%} Main Content {%- endcomment -%}
      <div>
        {%- comment -%} Toolbar {%- endcomment -%}
        <div class="modern-collection-toolbar">
          <div style="display:flex;align-items:center;gap:var(--space-md)">
            {%- if section.settings.show_filters -%}
              <button class="modern-filter-mobile-toggle" onclick="document.getElementById('FilterSidebar-{{ section.id }}').classList.add('is-open');document.getElementById('FilterOverlay-{{ section.id }}').classList.add('is-open')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h10M4 18h4"/></svg>
                Filters
              </button>
            {%- endif -%}
            <p style="font-size:var(--text-sm);opacity:0.6;margin:0">
              {{ collection.products_count }} {{ collection.products_count | pluralize: 'product', 'products' }}
            </p>
          </div>

          {%- if section.settings.show_sort -%}
            <div class="modern-sort-select">
              {%- assign sort_by = collection.sort_by | default: collection.default_sort_by -%}
              <select onchange="window.location.href=this.value">
                {%- for option in collection.sort_options -%}
                  <option value="{{ collection.url }}?sort_by={{ option.value }}" {% if option.value == sort_by %}selected{% endif %}>
                    {{ option.name | escape }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          {%- endif -%}
        </div>

        {%- comment -%} Active Filters {%- endcomment -%}
        {%- assign has_active_filters = false -%}
        {%- for filter in collection.filters -%}
          {%- if filter.active_values.size > 0 -%}
            {%- assign has_active_filters = true -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if has_active_filters -%}
          <div class="modern-active-filters">
            {%- for filter in collection.filters -%}
              {%- for value in filter.active_values -%}
                <a href="{{ value.url_to_remove }}" class="modern-active-filter-pill">
                  {{ filter.label }}: {{ value.label | escape }}
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </a>
              {%- endfor -%}
            {%- endfor -%}
            <a href="{{ collection.url }}" class="modern-active-filter-pill" style="font-weight:600">
              Clear all
            </a>
          </div>
        {%- endif -%}

        {%- comment -%} Product Grid {%- endcomment -%}
        {%- paginate collection.products by products_per_page -%}
          {%- if collection.products_count > 0 -%}
            <div class="modern-collection-product-grid" id="ProductGrid-{{ section.id }}">
              {%- for product in collection.products -%}
                {%- render 'modern-product-card',
                  product: product,
                  index: forloop.index,
                  show_vendor: section.settings.show_vendor,
                  animation: 'animate--fade-up'
                -%}
              {%- endfor -%}
            </div>

            {%- comment -%} Pagination {%- endcomment -%}
            {%- if paginate.pages > 1 -%}
              <div class="modern-load-more">
                {%- if paginate.next -%}
                  <a href="{{ paginate.next.url }}" class="modern-load-more__btn">
                    Load More
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                  </a>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- else -%}
            <div style="text-align:center;padding:var(--space-4xl) var(--space-xl)">
              <p style="font-size:var(--text-lg);opacity:0.5">No products found</p>
              {%- if has_active_filters -%}
                <a href="{{ collection.url }}" class="modern-btn modern-btn--outline" style="margin-top:var(--space-lg)">Clear all filters</a>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endpaginate -%}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Modern Collection Grid",
  "tag": "section",
  "class": "section-modern-collection-grid",
  "settings": [
    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 12,
      "label": "Products per page"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Desktop columns"
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "min": 1,
      "max": 2,
      "step": 1,
      "default": 2,
      "label": "Mobile columns"
    },
    {
      "type": "header",
      "content": "Filtering & Sorting"
    },
    {
      "type": "checkbox",
      "id": "show_filters",
      "default": true,
      "label": "Show filters"
    },
    {
      "type": "select",
      "id": "filter_layout",
      "label": "Filter layout",
      "options": [
        { "value": "sidebar", "label": "Sidebar" },
        { "value": "inline", "label": "Inline (above grid)" }
      ],
      "default": "sidebar"
    },
    {
      "type": "checkbox",
      "id": "show_sort",
      "default": true,
      "label": "Show sort dropdown"
    },
    {
      "type": "header",
      "content": "Display"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "select",
      "id": "pagination_type",
      "label": "Pagination type",
      "options": [
        { "value": "load_more", "label": "Load more button" },
        { "value": "numbered", "label": "Numbered pages" },
        { "value": "infinite", "label": "Infinite scroll" }
      ],
      "default": "load_more"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 40,
      "unit": "px",
      "label": "Padding top"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 52,
      "unit": "px",
      "label": "Padding bottom"
    }
  ],
  "presets": [
    {
      "name": "Modern Collection Grid"
    }
  ]
}
{% endschema %}
