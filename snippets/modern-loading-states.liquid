{%- comment -%}
  Modern Loading States
  =====================
  Reusable loading state components: button spinners, skeleton loaders,
  page transitions, form states, and blur-up image placeholders.

  Usage:
    {% render 'modern-loading-states' %}
    (Include once in theme.liquid or layout)
{%- endcomment -%}

<style>
  /* ==========================================================================
     1. Button Loading Spinner
     ========================================================================== */
  .modern-btn--loading {
    position: relative;
    color: transparent !important;
    pointer-events: none;
  }
  .modern-btn--loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: modernSpinBtn 0.6s linear infinite;
  }
  .modern-btn--outline.modern-btn--loading::after,
  .modern-btn--ghost.modern-btn--loading::after {
    border-color: rgba(0, 0, 0, 0.15);
    border-top-color: currentColor;
  }
  @keyframes modernSpinBtn {
    to { transform: rotate(360deg); }
  }

  /* ==========================================================================
     2. Skeleton Loaders
     ========================================================================== */
  .modern-skeleton {
    background: linear-gradient(
      90deg,
      rgba(128, 128, 128, 0.08) 25%,
      rgba(128, 128, 128, 0.15) 50%,
      rgba(128, 128, 128, 0.08) 75%
    );
    background-size: 200% 100%;
    animation: modernSkeletonShimmer 1.5s ease-in-out infinite;
    border-radius: var(--radius-md, 8px);
  }
  @keyframes modernSkeletonShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Product Card Skeleton */
  .modern-skeleton-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm, 8px);
  }
  .modern-skeleton-card__image {
    aspect-ratio: 1;
    border-radius: var(--radius-lg, 12px);
  }
  .modern-skeleton-card__title {
    height: 16px;
    width: 80%;
  }
  .modern-skeleton-card__price {
    height: 14px;
    width: 40%;
  }
  .modern-skeleton-card__swatch {
    display: flex;
    gap: var(--space-xs, 4px);
  }
  .modern-skeleton-card__swatch span {
    width: 20px;
    height: 20px;
    border-radius: 50%;
  }

  /* Text Skeleton */
  .modern-skeleton-text {
    height: 14px;
    margin-bottom: var(--space-xs, 4px);
  }
  .modern-skeleton-text:last-child {
    width: 60%;
  }
  .modern-skeleton-heading {
    height: 24px;
    width: 50%;
    margin-bottom: var(--space-md, 16px);
  }

  /* ==========================================================================
     3. Page Transition Loader
     ========================================================================== */
  .modern-page-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .modern-page-loader.is-loading {
    opacity: 1;
  }
  .modern-page-loader__bar {
    height: 100%;
    width: 0%;
    background: var(--color-button, var(--gradient-primary, #667eea));
    border-radius: 0 2px 2px 0;
    transition: width 0.4s ease;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
  }
  .modern-page-loader.is-loading .modern-page-loader__bar {
    animation: modernPageLoad 2s ease-in-out forwards;
  }
  .modern-page-loader.is-complete .modern-page-loader__bar {
    width: 100%;
    transition: width 0.2s ease, opacity 0.3s 0.2s ease;
    opacity: 0;
  }
  @keyframes modernPageLoad {
    0% { width: 0%; }
    20% { width: 30%; }
    50% { width: 60%; }
    80% { width: 80%; }
    100% { width: 90%; }
  }

  /* ==========================================================================
     4. Form Submission States
     ========================================================================== */
  .modern-form--submitting {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
  }
  .modern-form--submitting::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(2px);
    border-radius: inherit;
    z-index: 1;
  }
  .modern-form--success .modern-form__success-msg,
  .modern-form--error .modern-form__error-msg {
    display: flex;
    align-items: center;
    gap: var(--space-sm, 8px);
    padding: var(--space-md, 16px);
    border-radius: var(--radius-md, 8px);
    margin-top: var(--space-md, 16px);
    font-size: var(--text-sm, 14px);
    font-weight: 500;
    animation: modernFormMsgIn 0.3s ease-out;
  }
  .modern-form__success-msg {
    display: none;
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }
  .modern-form__error-msg {
    display: none;
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
  .modern-form__success-msg svg,
  .modern-form__error-msg svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  @keyframes modernFormMsgIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Input validation inline */
  .modern-input--valid {
    border-color: #10b981 !important;
  }
  .modern-input--invalid {
    border-color: #ef4444 !important;
  }
  .modern-input-error {
    font-size: var(--text-xs, 12px);
    color: #ef4444;
    margin-top: var(--space-xs, 4px);
    animation: modernFormMsgIn 0.2s ease-out;
  }

  /* ==========================================================================
     5. Image Blur-Up Placeholder
     ========================================================================== */
  .modern-blur-up {
    position: relative;
    overflow: hidden;
    background: rgba(128, 128, 128, 0.08);
  }
  .modern-blur-up img {
    transition: opacity 0.4s ease, filter 0.4s ease;
  }
  .modern-blur-up img[data-src]:not(.is-loaded) {
    filter: blur(20px);
    transform: scale(1.1);
  }
  .modern-blur-up img.is-loaded {
    filter: blur(0);
    transform: scale(1);
  }
  .modern-blur-up__placeholder {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(20px);
    transform: scale(1.1);
    transition: opacity 0.4s ease;
  }
  .modern-blur-up.is-loaded .modern-blur-up__placeholder {
    opacity: 0;
  }

  /* ==========================================================================
     6. Inline Spinner (text-level)
     ========================================================================== */
  .modern-spinner-inline {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid rgba(128, 128, 128, 0.2);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: modernSpinBtn 0.6s linear infinite;
    vertical-align: middle;
  }

  /* ==========================================================================
     7. Content Pulse (subtle loading indicator)
     ========================================================================== */
  .modern-pulse {
    animation: modernPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  @keyframes modernPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .modern-skeleton,
    .modern-btn--loading::after,
    .modern-spinner-inline {
      animation-duration: 3s;
    }
    .modern-page-loader.is-loading .modern-page-loader__bar {
      animation: none;
      width: 90%;
    }
    .modern-blur-up img[data-src]:not(.is-loaded) {
      filter: none;
      transform: none;
    }
    .modern-pulse {
      animation: none;
    }
  }
</style>

<!-- Page Transition Loader -->
<div class="modern-page-loader" id="ModernPageLoader" aria-hidden="true">
  <div class="modern-page-loader__bar"></div>
</div>

<script>
(function() {
  'use strict';

  var loader = document.getElementById('ModernPageLoader');
  if (!loader) return;

  /* Page navigation loader */
  document.addEventListener('click', function(e) {
    var link = e.target.closest('a[href]');
    if (!link) return;
    var href = link.getAttribute('href');
    if (!href || href.startsWith('#') || href.startsWith('javascript') ||
        link.target === '_blank' || link.hasAttribute('download') ||
        e.ctrlKey || e.metaKey || e.shiftKey) return;
    if (href.startsWith('http') && !href.includes(window.location.host)) return;
    loader.classList.add('is-loading');
    loader.classList.remove('is-complete');
  });

  window.addEventListener('pageshow', function() {
    loader.classList.remove('is-loading');
    loader.classList.add('is-complete');
    setTimeout(function() { loader.classList.remove('is-complete'); }, 500);
  });

  /* Button loading helper */
  window.ModernLoadingStates = {
    setButtonLoading: function(btn, loading) {
      if (loading) {
        btn.classList.add('modern-btn--loading');
        btn.setAttribute('aria-busy', 'true');
        btn.dataset.originalText = btn.textContent;
      } else {
        btn.classList.remove('modern-btn--loading');
        btn.removeAttribute('aria-busy');
      }
    },

    setFormSubmitting: function(form, submitting) {
      if (submitting) {
        form.classList.add('modern-form--submitting');
        var btn = form.querySelector('[type="submit"]');
        if (btn) this.setButtonLoading(btn, true);
      } else {
        form.classList.remove('modern-form--submitting');
        var btn = form.querySelector('[type="submit"]');
        if (btn) this.setButtonLoading(btn, false);
      }
    },

    showFormSuccess: function(form, message) {
      form.classList.remove('modern-form--submitting', 'modern-form--error');
      form.classList.add('modern-form--success');
      var msg = form.querySelector('.modern-form__success-msg');
      if (msg) msg.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' + message;
    },

    showFormError: function(form, message) {
      form.classList.remove('modern-form--submitting', 'modern-form--success');
      form.classList.add('modern-form--error');
      var msg = form.querySelector('.modern-form__error-msg');
      if (msg) msg.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' + message;
    },

    /* Blur-up image loader */
    initBlurUp: function() {
      var images = document.querySelectorAll('.modern-blur-up img[data-src]');
      if (!images.length) return;
      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (!entry.isIntersecting) return;
          var img = entry.target;
          var newImg = new Image();
          newImg.onload = function() {
            img.src = img.dataset.src;
            img.classList.add('is-loaded');
            img.closest('.modern-blur-up').classList.add('is-loaded');
          };
          newImg.src = img.dataset.src;
          observer.unobserve(img);
        });
      }, { rootMargin: '200px' });
      images.forEach(function(img) { observer.observe(img); });
    },

    /* Skeleton replacement helper */
    replaceSkeleton: function(container, html) {
      var temp = document.createElement('div');
      temp.innerHTML = html;
      temp.firstElementChild.style.opacity = '0';
      container.replaceWith(temp.firstElementChild);
      requestAnimationFrame(function() {
        temp.firstElementChild && (temp.firstElementChild.style.transition = 'opacity 0.3s ease');
        temp.firstElementChild && (temp.firstElementChild.style.opacity = '1');
      });
    }
  };

  /* Auto-init blur-up on load */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      window.ModernLoadingStates.initBlurUp();
    });
  } else {
    window.ModernLoadingStates.initBlurUp();
  }

  /* Re-init on Shopify section events */
  document.addEventListener('shopify:section:load', function() {
    window.ModernLoadingStates.initBlurUp();
  });
})();
</script>
